<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<title></title>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="format-detection" content="telephone=no">

	<link rel="stylesheet" type="text/css" href="magic/magic.css">
	<style type="text/css">
	*{margin: 0; padding: 0}
	img{border: none;}
	html{background: #edece9; overflow-y: scroll;}
	.container{max-width: 1180px; margin: auto}

	.waterfall{
		position: relative;
		/*overflow: hidden;*/
		border-top: solid 1px #0af;
		border-bottom: solid 10px #f08;
		margin: 1em auto;
		transition: 1s;
	}
	.waterfall-item{
		float: left;
		width: 20%;
		/*动画进行中会影响宽度的获取*/
		transition: .8s;
	}
	.waterfall-item a{
		margin: 8px;
		display: block;
		font-size: 12px;
		color: #bbb;
		text-decoration: none;
		background-color: #fff;
		box-shadow: 0 10px 40px #ccc;
	}
	@media (max-width: 960px){
		.waterfall-item{width: 25%}
	}
	@media (max-width: 768px){
		.waterfall-item{width: 33.333%}
	}
	@media (max-width: 480px){
		.waterfall-item{width: 50%}
		.waterfall-item a{margin: 4px}
	}
	.waterfall-item img{display: block; width: 100%}
	.img-name{
		padding: .75em;
		word-break: break-all;
		word-wrap: break-word;
	}
	</style>
</head>
<body>

<!-- container{ -->
<div class="container">

	<div class="waterfall">

		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (1).jpg">
				<div class="img-name">img/i (1).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (2).jpg">
				<div class="img-name">img/i (2).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (3).jpg">
				<div class="img-name">img/i (3).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (4).jpg">
				<div class="img-name">img/i (4).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (5).jpg">
				<div class="img-name">img/i (5).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (6).jpg">
				<div class="img-name">img/i (6).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (7).jpg">
				<div class="img-name">img/i (7).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (8).jpg">
				<div class="img-name">img/i (8).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (9).jpg">
				<div class="img-name">img/i (9).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (10).jpg">
				<div class="img-name"> img/i (10).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (11).jpg">
				<div class="img-name"> img/i (11).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (12).jpg">
				<div class="img-name"> img/i (12).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (13).jpg">
				<div class="img-name"> img/i (13).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (14).jpg">
				<div class="img-name"> img/i (14).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (15).jpg">
				<div class="img-name"> img/i (15).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (16).jpg">
				<div class="img-name"> img/i (16).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (17).jpg">
				<div class="img-name"> img/i (17).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (18).jpg">
				<div class="img-name"> img/i (18).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (19).jpg">
				<div class="img-name"> img/i (19).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="img/i (20).jpg">
				<div class="img-name"> img/i (20).jpg</div>
			</a>
		</div>
		
	<!-- </div>

	<div class="waterfall"> -->

		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/a6b85d9d2774019ce56d9292185214597d6ca581b34f8-odFokQ_fw658 ">
				<div class="img-name">img/i (1).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/eaaafc327575199c1a5dce82fcbb7c8291206d1975e3d-BMvFUY_fw658 ">
				<div class="img-name">img/i (2).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/a77dac69550d281835bc5f9a94b4b7a79a8ecf4114aa7-vd95IS_fw658 ">
				<div class="img-name">img/i (3).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/f7b5eec248457ea620d685f3f98c1c03a1ae25372e10c3-QAJXsJ_fw658 ">
				<div class="img-name">img/i (4).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/748832e043caa431e730beeb8d3c120c4bf93fcf255eb1-0M6r4x_fw658 ">
				<div class="img-name">img/i (5).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/e27469e791cd571279c846170982a6fe67a2d463279e8-knGXn1_fw658 ">
				<div class="img-name">img/i (6).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/66805e3db6d72f791e9821cbb947bab7724a6aa812d63-PIlUzv_fw658 ">
				<div class="img-name">img/i (7).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/6a73d26f9ebb3829f28959dea491e4d0918395ed76a00-v0OqAh_fw658 ">
				<div class="img-name">img/i (8).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/708af4e0ac5fbfa962010a1e71e6b121eca72e4d21eda-qj7PBJ_fw658 ">
				<div class="img-name">img/i (9).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/7878351a2227149959e8e5dbb2e05f5804f594492a214-ovcUyR_fw658 ">
				<div class="img-name"> img/i (10).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/04889d8162ede7c9620929fba107f6bca49b79bf1c09d-qBdpBu_fw658 ">
				<div class="img-name"> img/i (11).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/afa54fd6ed1e0762705d733a32fd9dd2ea55352421516-dQe6j8_fw658 ">
				<div class="img-name"> img/i (12).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/4f5560d1894652729ae535e17a87bd13991f46a02dbd4-3ljm5G_fw658 ">
				<div class="img-name"> img/i (13).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/d588c19731e157bc71a31fab107eeec1a7ef1a372a118-XevOIH_fw658 ">
				<div class="img-name"> img/i (14).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/5bace5df892481fac2a19422e6c56b583b3f0782a18e-CIpUdb_fw658 ">
				<div class="img-name"> img/i (15).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/032a8eb1f1ee54287f119f33723ca63921b63a86156ac1-RHqU68_fw658 ">
				<div class="img-name"> img/i (16).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/f03fc0ffab457b4f5b5be891148c8e5fbab84d5827d53-wtl4qS_fw658 ">
				<div class="img-name"> img/i (17).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/c5edfb3f21af824b9b64f2aaf834229edbdb294dcbe1-UXU6wQ_fw658 ">
				<div class="img-name"> img/i (18).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/355a8b2a9d84056e8e0283ddf37d23b3b2b4e7cc2dabdc-bSyq7F_fw658 ">
				<div class="img-name"> img/i (19).jpg</div>
			</a>
		</div>
		
		<div class="waterfall-item magictime spaceInDown">
			<a href="">
				<img src="http://img.hb.aicdn.com/7f2405835bd78e49d1061cff860f0be3bfa8a8c6a57db-8g90n3_fw658 ">
				<div class="img-name"> img/i (20).jpg</div>
			</a>
		</div>
		
	</div>

</div>
<!-- }container -->

<script type="text/javascript" src="jquery.js"></script>

<script id="tmpl" type="text/tmpl">
<div class="waterfall-item magictime spaceInDown">
	<a href="">
		<img src="$src">
		<div class="img-name">$name</div>
	</a>
</div>
</script>

<script type="text/javascript">
	testData = [/*
		// {img: {src: 'aaaa'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/f7adda670bf27b73dc37049e066ac40d16decc8846ffe-zBeWHd_fw658'}, name: '图片1', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/afa54fd6ed1e0762705d733a32fd9dd2ea55352421516-dQe6j8_fw658'}, name: '图片2', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/355a8b2a9d84056e8e0283ddf37d23b3b2b4e7cc2dabdc-bSyq7F_fw658'}, name: '图片3', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/c5edfb3f21af824b9b64f2aaf834229edbdb294dcbe1-UXU6wQ_fw658'}, name: '', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/708af4e0ac5fbfa962010a1e71e6b121eca72e4d21eda-qj7PBJ_fw658'}, name: '图片5', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/f03fc0ffab457b4f5b5be891148c8e5fbab84d5827d53-wtl4qS_fw658'}, name: 'http://img.hb.aicdn.com/f03fc0ffab457b4f5b5be891148c8e5fbab84d5827d53-wtl4qS_fw658', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/4f5560d1894652729ae535e17a87bd13991f46a02dbd4-3ljm5G_fw658'}, name: 'http://img.hb.aicdn.com/4f5560d1894652729ae535e17a87bd13991f46a02dbd4-3ljm5G_fw658', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/5bace5df892481fac2a19422e6c56b583b3f0782a18e-CIpUdb_fw658'}, name: 'http://img.hb.aicdn.com/5bace5df892481fac2a19422e6c56b583b3f0782a18e-CIpUdb_fw658', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/032a8eb1f1ee54287f119f33723ca63921b63a86156ac1-RHqU68_fw658'}, name: 'http://img.hb.aicdn.com/032a8eb1f1ee54287f119f33723ca63921b63a86156ac1-RHqU68_fw658', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/6a73d26f9ebb3829f28959dea491e4d0918395ed76a00-v0OqAh_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/7878351a2227149959e8e5dbb2e05f5804f594492a214-ovcUyR_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/66805e3db6d72f791e9821cbb947bab7724a6aa812d63-PIlUzv_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/04889d8162ede7c9620929fba107f6bca49b79bf1c09d-qBdpBu_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/d588c19731e157bc71a31fab107eeec1a7ef1a372a118-XevOIH_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/7f2405835bd78e49d1061cff860f0be3bfa8a8c6a57db-8g90n3_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/e27469e791cd571279c846170982a6fe67a2d463279e8-knGXn1_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/748832e043caa431e730beeb8d3c120c4bf93fcf255eb1-0M6r4x_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/f7b5eec248457ea620d685f3f98c1c03a1ae25372e10c3-QAJXsJ_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/a77dac69550d281835bc5f9a94b4b7a79a8ecf4114aa7-vd95IS_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/eaaafc327575199c1a5dce82fcbb7c8291206d1975e3d-BMvFUY_fw658'}, name: '图片', desc: '这是一张图片'},
		{img: {src: 'http://img.hb.aicdn.com/a6b85d9d2774019ce56d9292185214597d6ca581b34f8-odFokQ_fw658'}, name: '图片', desc: '这是一张图片'},

		{img: {src: 'img/i (1).jpg'}, name: 'img/i (1).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (2).jpg'}, name: 'img/i (2).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (3).jpg'}, name: 'img/i (3).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (4).jpg'}, name: 'img/i (4).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (5).jpg'}, name: 'img/i (5).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (6).jpg'}, name: 'img/i (6).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (7).jpg'}, name: 'img/i (7).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (8).jpg'}, name: 'img/i (8).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (9).jpg'}, name: 'img/i (9).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (10).jpg'}, name: 'img/i (10).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (11).jpg'}, name: 'img/i (11).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (12).jpg'}, name: 'img/i (12).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (13).jpg'}, name: 'img/i (13).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (14).jpg'}, name: 'img/i (14).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (15).jpg'}, name: 'img/i (15).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (16).jpg'}, name: 'img/i (16).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (17).jpg'}, name: 'img/i (17).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (18).jpg'}, name: 'img/i (18).jpg', descl: '这是一张图片'},
		{img: {src: 'img/i (19).jpg'}, name: 'img/i (19).jpg', desc: '这是一张图片'},
		{img: {src: 'img/i (20).jpg'}, name: 'img/i (20).jpg', desc: '这是一张图片'}*/
	];

	// waterfall({
	// 	container: '#waterfall',
	// 	item: '.waterfall-item',
	// 	url: 'img/',
	// 	pageCount: 10,

	// });

	var $waterfall = $('.waterfall');
	var tmpl = $('#tmpl').html();
	var colHeightArr = [];
	var imgIndex = 0;

	// 循环数据
	for (var i = 0; i < testData.length; i++) {
		var data = testData[i];

		// 创建模型
		var item = tmpl.replace('$src', data.img.src)
			.replace('$name', data.name);

		// 添加模型
		$item = $(item);
		// 加入文档
		// $waterfall.append($item);

		// 初始位置
		// $item.css({
		// 	position: 'absolute',
		// 	top: '800px',
		// 	left: '40%',
		// 	zIndex : 2,
		// 	opacity: 0,
		// });

		// 新建个 Image 对象，用于图片预加载
		var img = new Image;
		img.src = data.img.src;

		// 附加对应的数据，当加载完成时调用
		img.data = data;
		img.$item = $item;

		// 加载完成事件
		img.onload = function(){
			// 取出对应的数据
			var data = this.data;
			var $item = this.$item;
			// console.log('img: ', i, this.data);

			// ***********定位**********
			var x;
			var y;
			if (imgIndex<getCols()) {
				x = imgIndex * (getColWidth());
				y = 0;
			}else{
				var minColHeightIndex = getMinIndex(colHeightArr);
				x = minColHeightIndex * (getColWidth());
				y = colHeightArr[minColHeightIndex];
			};
			$item.css({
				position: 'absolute',
				top: y,
				left: x
				// zIndex : 2,
				// opacity: .1
			});
			// 加入文档。之后才能准确计算其高度
			$waterfall.append($item);

			// *********更新列高***********
			if (imgIndex<getCols()) {
				colHeightArr[imgIndex] = this.$item.height();
			}else{
				var minColHeightIndex = getMinIndex(colHeightArr);
				colHeightArr[minColHeightIndex] += this.$item.height();
			};
			// console.log(x,y, colHeightArr);

			// 更新容器高度
			$waterfall.height(Math.max.apply(null, colHeightArr));


			// setTimeout(function(){
			// 	$item.css({
			// 		position: 'absolute',
			// 		top: y,
			// 		left: x,
			// 		// left: Math.random()*1180,
			// 		// zIndex: 1,
			// 		// opacity: 1
			// 	});
			// }, Math.random()*500);

			// 标记 ++
			imgIndex++;

			// ---
			this.data = null;
			this.$item = null;
		}

	};

	// 获得列数
	function getCols () {
		return 5;
	}
	// 获得列宽
	function getColWidth () {
		return 236;
	}
	// 获得数组最小值的下标
	function getMinIndex (arr) {
		var minHeight = Math.min.apply(null, arr);
		for (var i = 0; i < arr.length; i++) {
			if (arr[i] == minHeight) {
				return i;
			};
		};
	}
	// 获得数组最大值的下标
	function getMaxIndex (arr) {
		var maxHeight = Math.max.apply(null, arr);
		for (var i = 0; i < arr.length; i++) {
			if (arr[i] == maxHeight) {
				return i;
			};
		};
	}

	// 响应
	var resizeTimer;
	$(window).resize(function(){
		clearTimeout(resizeTimer);
		resizeTimer = setTimeout(resize,1001);
	});
	function resize(){
		console.log('resize');

		var $items = $waterfall.children();

		var containerWidth = $waterfall.width();//容器宽
		var itemWidth = $items.width();//列宽/*动画进行中会影响宽度的获取*/
		var colNum = Math.round(containerWidth/itemWidth);//列数。不能直接取整，有时会出现4.999...的值，应为5列
		console.log(containerWidth, itemWidth, colNum)

		//初始化列高
		var tmpColHeightArr = new Array(colNum);
		for (var i = 0; i < tmpColHeightArr.length; i++) {
			tmpColHeightArr[i]=0;
		};

		// 重新摆放
		for (var i = 0; i < $items.length; i++) {
			var $item = $items.eq(i);
			var minColHeightIndex = getMinIndex(tmpColHeightArr);
			var x = minColHeightIndex/colNum *100 +'%';
			var y = tmpColHeightArr[minColHeightIndex];
			$item.css({
				position: 'absolute',
				left:x,
				top:y
			});
			// 更新列高
			tmpColHeightArr[minColHeightIndex]+=$item.height();
		};

		// 更新容器高
		$waterfall.height(Math.max.apply(null, tmpColHeightArr));
	}
	resize();

</script>
</body>
</html>